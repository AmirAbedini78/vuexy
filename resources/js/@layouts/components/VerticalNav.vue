<script setup>
import { layoutConfig } from "@layouts";
import {
  VerticalNavGroup,
  VerticalNavLink,
  VerticalNavSectionTitle,
} from "@layouts/components";
import { useLayoutConfigStore } from "@layouts/stores/config";
import { injectionKeyIsVerticalNavHovered } from "@layouts/symbols";
import { PerfectScrollbar } from "vue3-perfect-scrollbar";
import { VNodeRenderer } from "./VNodeRenderer";

const props = defineProps({
  tag: {
    type: null,
    required: false,
    default: "aside",
  },
  navItems: {
    type: null,
    required: true,
  },
  isOverlayNavActive: {
    type: Boolean,
    required: true,
  },
  toggleIsOverlayNavActive: {
    type: Function,
    required: true,
  },
});

const refNav = ref();
const isHovered = useElementHover(refNav);

provide(injectionKeyIsVerticalNavHovered, isHovered);

const configStore = useLayoutConfigStore();

const resolveNavItemComponent = (item) => {
  if ("heading" in item) return VerticalNavSectionTitle;
  if ("children" in item) return VerticalNavGroup;

  return VerticalNavLink;
};

/*ℹ️ Close overlay side when route is changed
Close overlay vertical nav when link is clicked
*/
const route = useRoute();

watch(
  () => route.name,
  () => {
    props.toggleIsOverlayNavActive(false);
  }
);

const isVerticalNavScrolled = ref(false);
const updateIsVerticalNavScrolled = (val) =>
  (isVerticalNavScrolled.value = val);

const handleNavScroll = (evt) => {
  isVerticalNavScrolled.value = evt.target.scrollTop > 0;
};

const hideTitleAndIcon = configStore.isVerticalNavMini(isHovered);
</script>

<template>
  <Component
    :is="props.tag"
    ref="refNav"
    data-allow-mismatch
    class="layout-vertical-nav"
    :class="[
      {
        'overlay-nav': configStore.isLessThanOverlayNavBreakpoint,
        hovered: isHovered,
        visible: isOverlayNavActive,
        scrolled: isVerticalNavScrolled,
      },
    ]"
  >
    <!-- 👉 Header -->
    <div class="nav-header">
      <slot name="nav-header">
        <RouterLink to="/" class="app-logo app-title-wrapper">
          <VNodeRenderer
            :nodes="layoutConfig.app.logo"
            :class="{
              'logo-collapsed':
                configStore.isVerticalNavCollapsed && !isHovered,
              'logo-expanded': !configStore.isVerticalNavCollapsed || isHovered,
            }"
          />

          <!-- App Title -->
          <Transition name="vertical-nav-app-title">
            <div v-show="!hideTitleAndIcon" class="app-title">
              <div class="app-title-line">Explorer</div>
              <div class="app-title-line">Elite</div>
            </div>
          </Transition>
        </RouterLink>
      </slot>
    </div>
    <slot name="before-nav-items">
      <div class="vertical-nav-items-shadow" />
    </slot>
    <slot
      name="nav-items"
      :update-is-vertical-nav-scrolled="updateIsVerticalNavScrolled"
    >
      <PerfectScrollbar
        :key="configStore.isAppRTL"
        tag="ul"
        class="nav-items"
        :options="{ wheelPropagation: false }"
        @ps-scroll-y="handleNavScroll"
      >
        <Component
          :is="resolveNavItemComponent(item)"
          v-for="(item, index) in navItems"
          :key="index"
          :item="item"
        />
      </PerfectScrollbar>
    </slot>
    <slot name="after-nav-items" />

    <!-- 👉 Bottom Button -->
    <div class="nav-bottom-button">
      <VBtn
        variant="outlined"
        color="primary"
        class="get-beyond-button"
        @click="() => $router.push('/get-support')"
      >
        <VIcon icon="tabler-ship" color="warning" class="me-2" />
        <span v-show="!hideTitleAndIcon" class="button-text">
          Get Support
        </span>
      </VBtn>
    </div>
  </Component>
</template>

<style lang="scss" scoped>
.app-logo {
  display: flex;
  align-items: center;
  column-gap: 0.75rem;

  .app-title {
    display: flex;
    flex-direction: column;
    line-height: 1.2;

    .app-title-line {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.25px;
      text-transform: capitalize;
      color: rgb(var(--v-theme-on-surface));
    }
  }

  // Dynamic logo sizing
  .logo-collapsed {
    transform: scale(0.7) translateX(-45px);
    transition: transform 0.3s ease;
  }

  .logo-expanded {
    transform: scale(1) translateX(0);
    transition: transform 0.3s ease;
  }
}

.nav-bottom-button {
  padding: 1rem;
  border-top: 1px solid rgba(var(--v-border-color), var(--v-border-opacity));
  margin-top: auto;

  .get-beyond-button {
    width: 100%;
    justify-content: flex-start;
    border-radius: 8px;
    font-weight: 600;
    text-transform: none;
    letter-spacing: 0.5px;

    .button-text {
      font-size: 0.875rem;
      font-weight: 600;
    }
  }
}

// Transition for app title
.vertical-nav-app-title-enter-active,
.vertical-nav-app-title-leave-active {
  transition: opacity 0.3s ease;
}

.vertical-nav-app-title-enter-from,
.vertical-nav-app-title-leave-to {
  opacity: 0;
}
</style>

<style lang="scss">
@use "@configured-variables" as variables;
@use "@layouts/styles/mixins";

// 👉 Vertical Nav
.layout-vertical-nav {
  position: fixed;
  z-index: variables.$layout-vertical-nav-z-index;
  display: flex;
  flex-direction: column;
  block-size: 100%;
  inline-size: variables.$layout-vertical-nav-width;
  inset-block-start: 0;
  inset-inline-start: 0;
  transition: inline-size 0.25s ease-in-out, box-shadow 0.25s ease-in-out;
  will-change: transform, inline-size;

  .nav-header {
    display: flex;
    align-items: center;
    padding: 1rem;

    .header-action {
      cursor: pointer;
    }
  }

  .nav-items {
    flex: 1;
    overflow-y: auto;
  }

  .nav-bottom-button {
    flex-shrink: 0;
  }
}
</style>
